---
import Container from '@/components/ui/Container.astro';
import Heading from '@/components/ui/Heading.astro';
import Layout from '@/layouts/Layout.astro';
import ProductSEO from '@/components/SEO/ProductSEO.astro';
import { ShopProductGrid } from '@/components/Product/ShopProductGrid';
import { getAllProducts } from '@/lib/db';

const url = new URL(Astro.request.url);
const categoryParam = url.searchParams.get('category');

// Get categories for SEO and initial load
let categories: string[] = [];
let initialProducts: any[] = [];
try {
  const result = await getAllProducts({
    isActive: true,
    limit: 20,
    offset: 0,
    category: categoryParam || '',
  });
  categories = result.categories;
  initialProducts = result.products;
} catch (error) {
  console.error('Error loading products from database:', error);
}


// SEO meta data
const seoTitle = categoryParam
  ? `${categoryParam} Products - Astro Ecom`
  : 'Shop All Products - Astro Ecom';
const seoDescription = categoryParam
  ? `Browse our ${categoryParam.toLowerCase()} collection. Quality products at great prices with fast shipping.`
  : `Discover our complete product collection. Quality items at competitive prices with fast shipping and excellent customer service.`;

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Shop', url: '/shop' },
  ...(categoryParam
    ? [{ name: categoryParam, url: `/shop?category=${categoryParam}` }]
    : []),
];
---

<ProductSEO
  title={seoTitle}
  description={seoDescription}
  products={initialProducts}
  breadcrumbs={breadcrumbs}
/>

<Layout>
  <Container width="marginxy">
    <Heading size="md" class="mb-8">Products</Heading>

    <ShopProductGrid
      initialProducts={initialProducts}
      initialCategory={categoryParam || ''}
      categories={categories}
      client:load
    />
  </Container>
</Layout>

