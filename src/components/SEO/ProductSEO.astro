---
interface Props {
  title: string;
  description: string;
  canonical?: string;
  image?: string;
  products?: Array<{
    id: string;
    name: string;
    description?: string;
    price: number;
    mrp: number;
    imagePath?: string;
    category: string;
    sku?: string;
    isActive: boolean;
    stock: number;
  }>;
  product?: {
    id: string;
    name: string;
    description?: string;
    price: number;
    mrp: number;
    imagePath?: string;
    category: string;
    sku?: string;
    isActive: boolean;
    stock: number;
    weight?: number;
    dimensions?: string;
    tags?: string;
  };
  breadcrumbs?: Array<{
    name: string;
    url: string;
  }>;
}

const {
  title,
  description,
  canonical,
  image,
  products,
  product,
  breadcrumbs
} = Astro.props;

const siteUrl = Astro.site?.toString() || 'https://astro-ecom-starter.mohansky.workers.dev';
const currentUrl = new URL(Astro.url.pathname, siteUrl).toString();
const canonicalUrl = canonical || currentUrl;

// Default image
const defaultImage = `${siteUrl}/og-image.jpg`;
const ogImage = image || defaultImage;

// Generate structured data for product list
function generateProductListSchema() {
  if (!products || products.length === 0) return null;

  return {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": title,
    "description": description,
    "numberOfItems": products.length,
    "itemListElement": products.map((product, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "item": {
        "@type": "Product",
        "@id": `${siteUrl}/shop/${product.id}`,
        "name": product.name,
        "description": product.description || product.name,
        "sku": product.sku,
        "category": product.category,
        "image": product.imagePath ? `https://pub-67b76734f5b543b9925c0870089929bb.r2.dev/products/${product.imagePath}/${product.imagePath}.jpg` : defaultImage,
        "offers": {
          "@type": "Offer",
          "price": product.price,
          "priceCurrency": "INR",
          "availability": product.stock > 0 && product.isActive ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
          "url": `${siteUrl}/shop/${product.id}`,
          "priceValidUntil": new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 30 days from now
        }
      }
    }))
  };
}

// Generate structured data for single product
function generateProductSchema() {
  if (!product) return null;

  return {
    "@context": "https://schema.org",
    "@type": "Product",
    "@id": `${siteUrl}/shop/${product.id}`,
    "name": product.name,
    "description": product.description || product.name,
    "sku": product.sku,
    "category": product.category,
    "brand": {
      "@type": "Brand",
      "name": "Astro Ecom"
    },
    "image": product.imagePath ? `https://pub-67b76734f5b543b9925c0870089929bb.r2.dev/products/${product.imagePath}/${product.imagePath}.jpg` : defaultImage,
    "offers": {
      "@type": "Offer",
      "price": product.price,
      "priceCurrency": "INR",
      "availability": product.stock > 0 && product.isActive ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
      "url": `${siteUrl}/shop/${product.id}`,
      "priceValidUntil": new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      "seller": {
        "@type": "Organization",
        "name": "Astro Ecom"
      }
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.5",
      "reviewCount": "10"
    },
    "weight": product.weight ? {
      "@type": "QuantitativeValue",
      "value": product.weight,
      "unitCode": "GRM"
    } : undefined,
    "additionalProperty": product.dimensions ? [{
      "@type": "PropertyValue",
      "name": "Dimensions",
      "value": product.dimensions
    }] : undefined,
    "keywords": product.tags
  };
}

// Generate breadcrumb schema
function generateBreadcrumbSchema() {
  if (!breadcrumbs || breadcrumbs.length === 0) return null;

  return {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": breadcrumbs.map((crumb, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": crumb.name,
      "item": `${siteUrl}${crumb.url}`
    }))
  };
}

const productListSchema = generateProductListSchema();
const productSchema = generateProductSchema();
const breadcrumbSchema = generateBreadcrumbSchema();
---

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow" />
<link rel="canonical" href={canonicalUrl} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={product ? "product" : "website"} />
<meta property="og:url" content={currentUrl} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImage} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:site_name" content="Astro Ecom" />
<meta property="og:locale" content="en_US" />

{product && (
  <>
    <meta property="product:price:amount" content={product.price.toString()} />
    <meta property="product:price:currency" content="INR" />
    <meta property="product:availability" content={product.stock > 0 && product.isActive ? "in stock" : "out of stock"} />
    <meta property="product:category" content={product.category} />
    <meta property="product:brand" content="Astro Ecom" />
  </>
)}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={currentUrl} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={ogImage} />

<!-- Additional SEO Meta -->
<meta name="author" content="Astro Ecom" />
<meta name="publisher" content="Astro Ecom" />
<meta name="theme-color" content="#000000" />
<meta name="msapplication-TileColor" content="#000000" />

<!-- Structured Data -->
{productListSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(productListSchema)} />
)}

{productSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(productSchema)} />
)}

{breadcrumbSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
)}

<!-- Website Organization Schema -->
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Astro Ecom",
  "url": siteUrl,
  "logo": `${siteUrl}/logo.png`,
  "sameAs": [
    "https://twitter.com/astroecom",
    "https://facebook.com/astroecom"
  ],
  "contactPoint": {
    "@type": "ContactPoint",
    "telephone": "+91-1234567890",
    "contactType": "customer service"
  }
})} />